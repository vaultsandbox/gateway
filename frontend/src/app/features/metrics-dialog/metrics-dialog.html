<p-dialog
  header="SMTP Gateway Metrics"
  [(visible)]="dialogVisible"
  (visibleChange)="onVisibleChange($event)"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '900px', maxWidth: '95vw' }"
>
  <!-- Loading State (show outside tabs when no data) -->
  @if (loading && !metrics && !storageMetrics && !webhookMetrics) {
    <div class="flex justify-center items-center py-12">
      <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
    </div>
  }

  <!-- Error State (show outside tabs when no data) -->
  @if (error && !metrics && !storageMetrics && !webhookMetrics) {
    <div
      class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded text-red-700 dark:text-red-400"
    >
      <i class="pi pi-exclamation-circle mr-2"></i>
      {{ error }}
    </div>
  }

  <!-- Tabbed Metrics Content -->
  @if (metrics || storageMetrics || webhookMetrics) {
    <p-tabs [value]="activeTab" (valueChange)="onTabChange($event)">
      <p-tablist>
        <p-tab value="general">General Metrics</p-tab>
        <p-tab value="storage">Storage Metrics</p-tab>
        <p-tab value="webhooks">Webhook Metrics</p-tab>
      </p-tablist>
      <p-tabpanels>
        <!-- General Metrics Tab -->
        <p-tabpanel value="general">
          @if (metrics) {
            <div class="space-y-6 pt-4">
              <!-- Server Uptime -->
              <div
                class="bg-gradient-to-r from-primary-50 to-primary-100 dark:from-primary-900/30 dark:to-primary-800/30 p-4 rounded-lg border border-primary-200 dark:border-primary-700"
              >
                <div class="flex items-center gap-3">
                  <i class="pi pi-server text-3xl text-primary-600 dark:text-primary-400"></i>
                  <div class="flex-1">
                    <div class="text-sm text-primary-700 dark:text-primary-300 font-medium mb-1">Server Uptime</div>
                    <div class="text-2xl font-bold text-primary-900 dark:text-primary-100">
                      {{ formatUptime(metrics.server.uptime_seconds) }}
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-primary-600 dark:text-primary-400 uppercase tracking-wide">Status</div>
                    <div class="flex items-center gap-1 mt-1">
                      <span class="inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                      <span class="text-sm font-semibold text-green-700 dark:text-green-400">Online</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Connection & Email Overview -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Total Connections -->
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Total Connections</div>
                  <div class="text-3xl font-bold text-surface-900 dark:text-surface-0">
                    {{ metrics.connections.total }}
                  </div>
                  <div class="text-xs text-surface-500 mt-1">
                    Rejected: {{ metrics.connections.rejected }} ({{ rejectionRate | number: '1.1-1' }}%)
                  </div>
                </div>

                <!-- Total Emails -->
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Emails Received</div>
                  <div class="text-3xl font-bold text-surface-900 dark:text-surface-0">
                    {{ metrics.email.received_total }}
                  </div>
                  <div class="text-xs text-surface-500 mt-1">
                    Recipients: {{ metrics.email.recipients_total }} ({{ avgRecipientsPerEmail | number: '1.1-1' }} avg)
                  </div>
                </div>

                <!-- Active Connections -->
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Active Now</div>
                  <div class="text-3xl font-bold text-primary">
                    {{ metrics.connections.active }}
                  </div>
                  <div class="text-xs text-surface-500 mt-1">
                    Processing: {{ formatProcessingTime(metrics.email.processing_time_ms) }} avg
                  </div>
                </div>
              </div>

              <!-- Inbox Activity -->
              <div
                class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
              >
                <div class="text-base font-semibold text-surface-900 dark:text-surface-0 mb-4">Inbox Activity</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <!-- Created Inboxes -->
                  <div
                    class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700"
                  >
                    <div class="text-xs text-blue-700 dark:text-blue-300 uppercase tracking-wide mb-1">Created</div>
                    <div class="text-3xl font-bold text-blue-900 dark:text-blue-100">
                      {{ metrics.inbox.created_total }}
                    </div>
                    <div class="text-xs text-blue-600 dark:text-blue-400 mt-1">Total</div>
                  </div>

                  <!-- Active Inboxes -->
                  <div
                    class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700"
                  >
                    <div class="text-xs text-green-700 dark:text-green-300 uppercase tracking-wide mb-1">Active</div>
                    <div class="text-3xl font-bold text-green-900 dark:text-green-100">
                      {{ metrics.inbox.active_total }}
                    </div>
                    <div class="text-xs text-green-600 dark:text-green-400 mt-1">Live</div>
                  </div>

                  <!-- Deleted Inboxes -->
                  <div
                    class="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-700"
                  >
                    <div class="text-xs text-red-700 dark:text-red-300 uppercase tracking-wide mb-1">Deleted</div>
                    <div class="text-3xl font-bold text-red-900 dark:text-red-100">
                      {{ metrics.inbox.deleted_total }}
                    </div>
                    <div class="text-xs text-red-600 dark:text-red-400 mt-1">Total</div>
                  </div>
                </div>
              </div>

              <!-- Email Authentication -->
              <div
                class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
              >
                <div class="text-base font-semibold text-surface-900 dark:text-surface-0 mb-4">
                  Email Authentication
                </div>
                <div class="space-y-3">
                  <!-- SPF -->
                  <div>
                    <div class="flex justify-between items-center mb-1">
                      <div class="flex items-center gap-2">
                        <span class="text-sm font-medium">SPF</span>
                        <i class="pi text-sm" [ngClass]="getAuthStatusIcon(authPassRates.spf)"></i>
                      </div>
                      <span class="text-sm font-semibold">
                        {{ metrics.auth.spf_pass }}/{{ metrics.auth.spf_pass + metrics.auth.spf_fail }} ({{
                          authPassRates.spf | number: '1.1-1'
                        }}%)
                      </span>
                    </div>
                    <p-progressBar
                      [value]="authPassRates.spf"
                      [showValue]="false"
                      [style]="{ height: '8px' }"
                      [styleClass]="'auth-progress-' + getAuthStatusSeverity(authPassRates.spf)"
                    />
                  </div>

                  <!-- DKIM -->
                  <div>
                    <div class="flex justify-between items-center mb-1">
                      <div class="flex items-center gap-2">
                        <span class="text-sm font-medium">DKIM</span>
                        <i class="pi text-sm" [ngClass]="getAuthStatusIcon(authPassRates.dkim)"></i>
                      </div>
                      <span class="text-sm font-semibold">
                        {{ metrics.auth.dkim_pass }}/{{ metrics.auth.dkim_pass + metrics.auth.dkim_fail }} ({{
                          authPassRates.dkim | number: '1.1-1'
                        }}%)
                      </span>
                    </div>
                    <p-progressBar
                      [value]="authPassRates.dkim"
                      [showValue]="false"
                      [style]="{ height: '8px' }"
                      [styleClass]="'auth-progress-' + getAuthStatusSeverity(authPassRates.dkim)"
                    />
                  </div>

                  <!-- DMARC -->
                  <div>
                    <div class="flex justify-between items-center mb-1">
                      <div class="flex items-center gap-2">
                        <span class="text-sm font-medium">DMARC</span>
                        <i class="pi text-sm" [ngClass]="getAuthStatusIcon(authPassRates.dmarc)"></i>
                      </div>
                      <span class="text-sm font-semibold">
                        {{ metrics.auth.dmarc_pass }}/{{ metrics.auth.dmarc_pass + metrics.auth.dmarc_fail }} ({{
                          authPassRates.dmarc | number: '1.1-1'
                        }}%)
                      </span>
                    </div>
                    <p-progressBar
                      [value]="authPassRates.dmarc"
                      [showValue]="false"
                      [style]="{ height: '8px' }"
                      [styleClass]="'auth-progress-' + getAuthStatusSeverity(authPassRates.dmarc)"
                    />
                  </div>
                </div>
                <div class="mt-3 text-xs text-surface-500">
                  <i class="pi pi-info-circle mr-1"></i>
                  Authentication checks are non-blocking. Emails are accepted regardless of validation results.
                </div>
              </div>

              <!-- Rejections -->
              <div
                class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
              >
                <div class="flex items-center gap-2 text-base font-semibold text-surface-900 dark:text-surface-0 mb-3">
                  <span>Rejections ({{ totalRejections }} total)</span>
                  <i
                    class="pi pi-info-circle text-surface-500 text-sm"
                    pTooltip="Senders rejected, recipients rejected, size limit violations, invalid SMTP commands, hard mode challenges, and rate limit rejections (connections or MAIL FROM blocked by the SMTP rate limiter)."
                    tooltipPosition="top"
                  ></i>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                  <div>
                    <div class="text-xs text-surface-600 dark:text-surface-400">Senders</div>
                    <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                      {{ metrics.rejections.sender_rejected_total }}
                    </div>
                  </div>
                  <div>
                    <div class="text-xs text-surface-600 dark:text-surface-400">Recipients</div>
                    <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                      {{ metrics.rejections.recipient_rejected_total }}
                    </div>
                  </div>
                  <div>
                    <div class="text-xs text-surface-600 dark:text-surface-400">Size Limit</div>
                    <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                      {{ metrics.rejections.data_rejected_size_total }}
                    </div>
                  </div>
                  <div>
                    <div class="text-xs text-surface-600 dark:text-surface-400">Invalid Cmds</div>
                    <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                      {{ metrics.rejections.invalid_commands }}
                    </div>
                  </div>
                  <div>
                    <div class="text-xs text-surface-600 dark:text-surface-400">Hard Mode</div>
                    <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                      {{ metrics.rejections.hard_mode_total }}
                    </div>
                  </div>
                  <div data-testid="rate-limit-rejections">
                    <div class="text-xs text-surface-600 dark:text-surface-400">Rate Limit Rejections</div>
                    <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                      {{ metrics.rejections.rate_limit_total }}
                    </div>
                    <div class="text-xs text-surface-500 mt-1">
                      Connections or MAIL FROM blocked by the SMTP rate limiter.
                    </div>
                  </div>
                </div>
                @if (metrics.rejections.recipient_rejected_total > 10) {
                  <div
                    class="mt-3 p-2 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded text-xs text-yellow-700 dark:text-yellow-400"
                  >
                    <i class="pi pi-exclamation-triangle mr-1"></i>
                    High recipient rejections may indicate spam attempts or misconfigured senders.
                  </div>
                }
              </div>

              <!-- TLS Certificate -->
              <div
                class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
              >
                <div class="text-base font-semibold text-surface-900 dark:text-surface-0 mb-3">TLS Certificate</div>
                <div class="flex items-start gap-3">
                  <i
                    class="pi text-2xl"
                    [ngClass]="getCertStatusIcon(certificateStatus)"
                    [class.text-green-600]="certificateStatus === 'healthy'"
                    [class.text-yellow-600]="certificateStatus === 'warning'"
                    [class.text-red-600]="certificateStatus === 'critical' || certificateStatus === 'expired'"
                    [class.text-surface-400]="certificateStatus === 'disabled'"
                  ></i>
                  <div class="flex-1">
                    <div class="font-medium text-surface-900 dark:text-surface-0">
                      {{ getCertStatusText(certificateStatus, metrics.certificate.days_until_expiry) }}
                    </div>
                    @if (certificateStatus !== 'disabled') {
                      <div class="text-sm text-surface-600 dark:text-surface-400 mt-1">
                        Renewals: {{ metrics.certificate.renewal_success }} successful,
                        {{ metrics.certificate.renewal_failures }} failed
                        @if (metrics.certificate.renewal_attempts > 0) {
                          <span> ({{ certRenewalSuccessRate | number: '1.0-0' }}% success rate) </span>
                        }
                      </div>
                    }
                    @if (metrics.certificate.renewal_failures > 0) {
                      <div
                        class="mt-2 p-2 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded text-xs text-red-700 dark:text-red-400"
                      >
                        <i class="pi pi-exclamation-circle mr-1"></i>
                        Certificate renewal failures detected. Check server logs.
                      </div>
                    }
                  </div>
                </div>
              </div>

              <!-- Processing Performance -->
              <div
                class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
              >
                <div class="text-base font-semibold text-surface-900 dark:text-surface-0 mb-3">
                  Processing Performance
                </div>
                <div class="flex items-center gap-3">
                  <div class="flex-1">
                    <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Average Processing Time</div>
                    <div
                      class="text-2xl font-bold"
                      [class.text-green-600]="processingTimeStatus === 'fast'"
                      [class.text-yellow-600]="processingTimeStatus === 'acceptable'"
                      [class.text-red-600]="processingTimeStatus === 'slow'"
                    >
                      {{ formatProcessingTime(metrics.email.processing_time_ms) }}
                    </div>
                  </div>
                  <p-badge
                    [value]="
                      processingTimeStatus === 'fast' ? 'Fast' : processingTimeStatus === 'acceptable' ? 'OK' : 'Slow'
                    "
                    [severity]="getProcessingTimeSeverity(processingTimeStatus)"
                  />
                </div>
                <div class="mt-2 text-xs text-surface-500">
                  <span class="text-green-600 dark:text-green-400">&lt; 500ms: Fast</span> •
                  <span class="text-yellow-600 dark:text-yellow-400">500-2000ms: OK</span> •
                  <span class="text-red-600 dark:text-red-400">&gt; 2000ms: Slow</span>
                </div>
              </div>

              <!-- Info Note -->
              <div
                class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded text-xs text-blue-700 dark:text-blue-400"
              >
                <i class="pi pi-info-circle mr-1"></i>
                <strong>Note:</strong> All metrics are in-memory and reset when the server restarts. Metrics refresh
                automatically every 5 seconds.
              </div>
            </div>
          } @else {
            <div class="flex justify-center items-center py-12">
              <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
            </div>
          }
        </p-tabpanel>

        <!-- Storage Metrics Tab -->
        <p-tabpanel value="storage">
          @if (storageMetrics?.error) {
            <!-- Storage Not Available -->
            <div
              class="p-4 mt-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded text-yellow-700 dark:text-yellow-400"
            >
              <i class="pi pi-exclamation-triangle mr-2"></i>
              <strong>Storage metrics unavailable:</strong> {{ storageMetrics?.reason }}
            </div>
          } @else if (storageMetrics) {
            <div class="space-y-6 pt-4">
              <!-- Memory Usage Overview -->
              <div
                class="bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/30 p-4 rounded-lg border border-purple-200 dark:border-purple-700"
              >
                <div class="flex items-center gap-3">
                  <i class="pi pi-database text-3xl text-purple-600 dark:text-purple-400"></i>
                  <div class="flex-1">
                    <div class="text-sm text-purple-700 dark:text-purple-300 font-medium mb-1">Memory Utilization</div>
                    <div class="text-2xl font-bold text-purple-900 dark:text-purple-100">
                      {{ storageMetrics.storage.utilizationPercent }}%
                    </div>
                    <div class="text-xs text-purple-600 dark:text-purple-400 mt-1">
                      {{ storageMetrics.storage.usedMemoryMB }} MB / {{ storageMetrics.storage.maxMemoryMB }} MB
                    </div>
                  </div>
                  <div class="text-right">
                    <p-badge
                      [value]="
                        storageHealthStatus === 'healthy'
                          ? 'Healthy'
                          : storageHealthStatus === 'warning'
                            ? 'Warning'
                            : 'Critical'
                      "
                      [severity]="
                        storageHealthStatus === 'healthy'
                          ? 'success'
                          : storageHealthStatus === 'warning'
                            ? 'warn'
                            : 'danger'
                      "
                    />
                  </div>
                </div>
                <div class="mt-3">
                  <p-progressBar
                    [value]="+storageMetrics.storage.utilizationPercent"
                    [showValue]="false"
                    [style]="{ height: '10px' }"
                  />
                </div>
              </div>

              <!-- Email Storage Stats -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Stored Emails -->
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Stored Emails</div>
                  <div class="text-3xl font-bold text-surface-900 dark:text-surface-0">
                    {{ storageMetrics.emails.totalStored }}
                  </div>
                  <div class="text-xs text-surface-500 mt-1">Currently in storage</div>
                </div>

                <!-- Tombstones -->
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Tombstones</div>
                  <div class="text-3xl font-bold text-primary">
                    {{ storageMetrics.emails.tombstones }}
                  </div>
                  <div class="text-xs text-surface-500 mt-1">Awaiting compaction</div>
                </div>

                <!-- Total Evicted -->
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Evicted Total</div>
                  <div class="text-3xl font-bold text-surface-900 dark:text-surface-0">
                    {{ storageMetrics.emails.totalEvicted }}
                  </div>
                  <div class="text-xs text-surface-500 mt-1">Lifetime evictions</div>
                </div>
              </div>

              <!-- Email Age Info -->
              @if (storageMetrics.emails.oldestEmailAge !== null || storageMetrics.emails.newestEmailAge !== null) {
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-base font-semibold text-surface-900 dark:text-surface-0 mb-4">Email Age</div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <div class="text-xs text-surface-600 dark:text-surface-400">Oldest Email</div>
                      <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                        {{
                          storageMetrics.emails.oldestEmailAge !== null
                            ? formatDurationMs(storageMetrics.emails.oldestEmailAge)
                            : 'N/A'
                        }}
                      </div>
                    </div>
                    <div>
                      <div class="text-xs text-surface-600 dark:text-surface-400">Newest Email</div>
                      <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                        {{
                          storageMetrics.emails.newestEmailAge !== null
                            ? formatDurationMs(storageMetrics.emails.newestEmailAge)
                            : 'N/A'
                        }}
                      </div>
                    </div>
                  </div>
                </div>
              }

              <!-- Eviction Configuration -->
              <div
                class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
              >
                <div class="flex items-center gap-2 text-base font-semibold text-surface-900 dark:text-surface-0 mb-3">
                  <span>Eviction Policy</span>
                  <i
                    class="pi pi-info-circle text-surface-500 text-sm"
                    pTooltip="Time-based eviction automatically removes emails older than the configured max age."
                    tooltipPosition="top"
                  ></i>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <div class="text-xs text-surface-600 dark:text-surface-400">Time-Based Eviction</div>
                    <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                      {{ storageMetrics.eviction.maxAgeEnabled ? 'Enabled' : 'Disabled' }}
                    </div>
                  </div>
                  @if (storageMetrics.eviction.maxAgeEnabled && storageMetrics.eviction.maxAgeSeconds !== null) {
                    <div>
                      <div class="text-xs text-surface-600 dark:text-surface-400">Max Age</div>
                      <div class="text-xl font-bold text-surface-900 dark:text-surface-0">
                        {{ formatDuration(storageMetrics.eviction.maxAgeSeconds) }}
                      </div>
                    </div>
                  }
                </div>
              </div>

              <!-- Configuration Info -->
              <div
                class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded text-xs text-blue-700 dark:text-blue-400"
              >
                <i class="pi pi-info-circle mr-1"></i>
                <strong>Memory:</strong>
                {{ storageMetrics.storage.availableMemoryMB }} MB available of
                {{ storageMetrics.storage.maxMemoryMB }} MB total
              </div>
            </div>
          } @else {
            <div class="flex justify-center items-center py-12">
              <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
            </div>
          }
        </p-tabpanel>

        <!-- Webhook Metrics Tab -->
        <p-tabpanel value="webhooks">
          @if (webhookMetrics) {
            <div class="space-y-6 pt-4">
              <!-- Webhook Delivery Overview -->
              <div
                class="bg-gradient-to-r from-teal-50 to-teal-100 dark:from-teal-900/30 dark:to-teal-800/30 p-4 rounded-lg border border-teal-200 dark:border-teal-700"
              >
                <div class="flex items-center gap-3">
                  <i class="pi pi-bolt text-3xl text-teal-600 dark:text-teal-400"></i>
                  <div class="flex-1">
                    <div class="text-sm text-teal-700 dark:text-teal-300 font-medium mb-1">Delivery Success Rate</div>
                    <div class="text-2xl font-bold text-teal-900 dark:text-teal-100">
                      {{ webhookDeliverySuccessRate | number: '1.1-1' }}%
                    </div>
                    <div class="text-xs text-teal-600 dark:text-teal-400 mt-1">
                      {{ webhookMetrics.deliveries.successful }} of {{ webhookMetrics.deliveries.total }} deliveries
                    </div>
                  </div>
                  <div class="text-right">
                    <p-badge
                      [value]="
                        webhookDeliverySuccessRate >= 95
                          ? 'Healthy'
                          : webhookDeliverySuccessRate >= 80
                            ? 'Warning'
                            : 'Critical'
                      "
                      [severity]="
                        webhookDeliverySuccessRate >= 95
                          ? 'success'
                          : webhookDeliverySuccessRate >= 80
                            ? 'warn'
                            : 'danger'
                      "
                    />
                  </div>
                </div>
                <div class="mt-3">
                  <p-progressBar
                    [value]="webhookDeliverySuccessRate"
                    [showValue]="false"
                    [style]="{ height: '10px' }"
                  />
                </div>
              </div>

              <!-- Webhook Counts -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Total Webhooks -->
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Total Webhooks</div>
                  <div class="text-3xl font-bold text-surface-900 dark:text-surface-0">
                    {{ webhookMetrics.webhooks.total }}
                  </div>
                  <div class="text-xs text-surface-500 mt-1">{{ webhookMetrics.webhooks.enabled }} enabled</div>
                </div>

                <!-- Global Webhooks -->
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Global Webhooks</div>
                  <div class="text-3xl font-bold text-primary">
                    {{ webhookMetrics.webhooks.global }}
                  </div>
                  <div class="text-xs text-surface-500 mt-1">Server-wide hooks</div>
                </div>

                <!-- Inbox Webhooks -->
                <div
                  class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
                >
                  <div class="text-sm text-surface-600 dark:text-surface-400 mb-1">Inbox Webhooks</div>
                  <div class="text-3xl font-bold text-surface-900 dark:text-surface-0">
                    {{ webhookMetrics.webhooks.inbox }}
                  </div>
                  <div class="text-xs text-surface-500 mt-1">Inbox-specific hooks</div>
                </div>
              </div>

              <!-- Delivery Stats -->
              <div
                class="bg-surface-50 dark:bg-surface-800 p-4 rounded-lg border border-surface-200 dark:border-surface-700"
              >
                <div class="text-base font-semibold text-surface-900 dark:text-surface-0 mb-4">Delivery Statistics</div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <!-- Total Deliveries -->
                  <div
                    class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-700"
                  >
                    <div class="text-xs text-blue-700 dark:text-blue-300 uppercase tracking-wide mb-1">Total</div>
                    <div class="text-3xl font-bold text-blue-900 dark:text-blue-100">
                      {{ webhookMetrics.deliveries.total }}
                    </div>
                    <div class="text-xs text-blue-600 dark:text-blue-400 mt-1">Attempts</div>
                  </div>

                  <!-- Successful Deliveries -->
                  <div
                    class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-700"
                  >
                    <div class="text-xs text-green-700 dark:text-green-300 uppercase tracking-wide mb-1">
                      Successful
                    </div>
                    <div class="text-3xl font-bold text-green-900 dark:text-green-100">
                      {{ webhookMetrics.deliveries.successful }}
                    </div>
                    <div class="text-xs text-green-600 dark:text-green-400 mt-1">Delivered</div>
                  </div>

                  <!-- Failed Deliveries -->
                  <div
                    class="text-center p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-700"
                  >
                    <div class="text-xs text-red-700 dark:text-red-300 uppercase tracking-wide mb-1">Failed</div>
                    <div class="text-3xl font-bold text-red-900 dark:text-red-100">
                      {{ webhookMetrics.deliveries.failed }}
                    </div>
                    <div class="text-xs text-red-600 dark:text-red-400 mt-1">Errors</div>
                  </div>
                </div>
              </div>

              @if (webhookMetrics.deliveries.failed > 0 && webhookDeliverySuccessRate < 95) {
                <div
                  class="p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded text-xs text-yellow-700 dark:text-yellow-400"
                >
                  <i class="pi pi-exclamation-triangle mr-1"></i>
                  Some webhook deliveries are failing. Check your webhook endpoints and server logs.
                </div>
              }

              <!-- Info Note -->
              <div
                class="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded text-xs text-blue-700 dark:text-blue-400"
              >
                <i class="pi pi-info-circle mr-1"></i>
                <strong>Note:</strong> Webhook metrics are aggregated across all configured webhooks. Metrics refresh
                automatically every 5 seconds.
              </div>
            </div>
          } @else {
            <div class="flex justify-center items-center py-12">
              <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
            </div>
          }
        </p-tabpanel>
      </p-tabpanels>
    </p-tabs>
  }

  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center w-full">
      <p-button label="Refresh" icon="pi pi-refresh" [text]="true" (onClick)="onRefresh()" [loading]="loading" />
      <p-button label="Close" (onClick)="onClose()" />
    </div>
  </ng-template>
</p-dialog>
