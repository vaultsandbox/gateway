<div class="email-detail-container h-full flex flex-col min-w-0 overflow-hidden">
  <p-confirmpopup key="emailDetailDelete"></p-confirmpopup>
  @if (email) {
    <div class="flex items-center justify-between mb-4 pb-4 border-b border-surface-200 dark:border-surface-700">
      <div class="flex items-center gap-4">
        <p-button
          icon="pi pi-arrow-left"
          [text]="true"
          [rounded]="true"
          (onClick)="onBackClick()"
          severity="secondary"
          label="Back"
        />
      </div>

      <div class="flex gap-2 shrink-0">
        @if (activeTab === 'html') {
          <p-button
            [icon]="isTakingScreenshot ? 'pi pi-spinner pi-spin' : 'pi pi-camera'"
            [text]="true"
            severity="secondary"
            (onClick)="downloadScreenshot()"
            [disabled]="isTakingScreenshot || !email.parsedContent || isRenderingContent"
            pTooltip="Save screenshot"
            tooltipPosition="bottom"
          />
        }
        <p-button
          [icon]="isDownloadingRaw ? 'pi pi-spinner pi-spin' : 'pi pi-download'"
          [text]="true"
          severity="secondary"
          (onClick)="downloadRawEmail()"
          [disabled]="isDownloadingRaw || !email.parsedContent || isRenderingContent"
          pTooltip="Download raw email file"
          tooltipPosition="bottom"
        />
        <p-button
          [icon]="isDeletingEmail ? 'pi pi-spinner pi-spin' : 'pi pi-trash'"
          [text]="true"
          severity="danger"
          (onClick)="confirmDelete($event)"
          [disabled]="isDeletingEmail || !email"
          pTooltip="Delete email"
          tooltipPosition="bottom"
        />
      </div>
    </div>

    <div class="mb-4 space-y-2">
      <h1 class="text-2xl font-bold text-surface-900 dark:text-surface-100">
        {{ email.parsedContent?.subject || email.decryptedMetadata?.subject || '(no subject)' }}
      </h1>

      <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 text-sm">
        <span class="text-surface-500 dark:text-surface-400 font-semibold">From:</span>
        <span class="text-surface-900 dark:text-surface-100">
          {{ email.parsedContent?.from || email.decryptedMetadata?.from || 'Unknown' }}
        </span>

        <span class="text-surface-500 dark:text-surface-400 font-semibold">To:</span>
        <span class="text-surface-900 dark:text-surface-100">
          {{ email.parsedContent?.to || email.decryptedMetadata?.to || '' }}
        </span>

        @if (email.parsedContent?.cc) {
          <span class="text-surface-500 dark:text-surface-400 font-semibold">Cc:</span>
          <span class="text-surface-900 dark:text-surface-100">{{ email.parsedContent!.cc }}</span>
        }

        <span class="text-surface-500 dark:text-surface-400 font-semibold">Date:</span>
        <span class="text-surface-900 dark:text-surface-100">
          {{ dateFormatter.format(email.parsedContent?.date || email.decryptedMetadata?.receivedAt || '', 'detailed') }}
        </span>
      </div>
    </div>

    <div class="flex-1 overflow-hidden min-w-0">
      @if (email.isLoadingBody !== false || isRenderingContent) {
        <div class="flex flex-col items-center justify-center h-full gap-4">
          <p-progressSpinner class="w-12 h-12" strokeWidth="4" />
          <p class="text-surface-500 dark:text-surface-400">Loading email content...</p>
        </div>
      } @else if (email.parsedContent) {
        <p-tabs [(value)]="activeTab" class="h-full email-tabs" scrollable>
          <p-tablist>
            <p-tab value="html">
              <div class="flex items-center gap-2">
                <i class="pi pi-code"></i>
                <span>HTML</span>
                @if (!hasHtml()) {
                  <i class="pi pi-ban text-surface-400 text-xs"></i>
                }
              </div>
            </p-tab>

            <p-tab value="text">
              <div class="flex items-center gap-2">
                <i class="pi pi-align-left"></i>
                <span>Text</span>
                @if (!hasText()) {
                  <i class="pi pi-ban text-surface-400 text-xs"></i>
                }
              </div>
            </p-tab>

            <p-tab value="headers">
              <div class="flex items-center gap-2">
                <i class="pi pi-list"></i>
                <span>Headers</span>
                <span class="text-xs bg-surface-200 dark:bg-surface-700 px-2 py-0.5 rounded">
                  {{ getHeadersList().length }}
                </span>
              </div>
            </p-tab>

            <p-tab value="auth">
              <div class="flex items-center gap-2">
                <i class="pi pi-shield"></i>
                <span>Authentication</span>
                @if (getAuthFailureCount() > 0) {
                  <span class="text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-2 py-0.5 rounded">
                    {{ getAuthFailureCount() }}
                  </span>
                }
              </div>
            </p-tab>

            @if (isSpamAnalysisEnabled()) {
              <p-tab value="spam">
                <div class="flex items-center gap-2">
                  <i class="pi pi-flag"></i>
                  <span>Spam</span>
                  @if (hasSpamAnalysis() && email.parsedContent!.spamAnalysis!.status === 'analyzed') {
                    @if (email.parsedContent!.spamAnalysis!.isSpam) {
                      <span
                        class="text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-2 py-0.5 rounded"
                      >
                        {{ email.parsedContent!.spamAnalysis!.score!.toFixed(1) }}
                      </span>
                    } @else if (
                      email.parsedContent!.spamAnalysis!.score !== undefined &&
                      email.parsedContent!.spamAnalysis!.score >= 3
                    ) {
                      <span
                        class="text-xs bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 px-2 py-0.5 rounded"
                      >
                        {{ email.parsedContent!.spamAnalysis!.score!.toFixed(1) }}
                      </span>
                    }
                  }
                </div>
              </p-tab>
            }

            @if (hasAttachments()) {
              <p-tab value="attachments">
                <div class="flex items-center gap-2">
                  <i class="pi pi-paperclip"></i>
                  <span>Attachments</span>
                  <span class="text-xs bg-surface-200 dark:bg-surface-700 px-2 py-0.5 rounded">
                    {{ email.parsedContent!.attachments.length }}
                  </span>
                </div>
              </p-tab>
            }

            @if (hasLinks()) {
              <p-tab value="links">
                <div class="flex items-center gap-2">
                  <i class="pi pi-link"></i>
                  <span>Links</span>
                  <span class="text-xs bg-surface-200 dark:bg-surface-700 px-2 py-0.5 rounded">
                    {{ email.parsedContent!.links!.length }}
                  </span>
                </div>
              </p-tab>
            }
          </p-tablist>

          <p-tabpanels>
            <p-tabpanel value="html">
              <div class="h-full overflow-auto p-4">
                @if (hasHtml()) {
                  @if (useIframeRendering) {
                    <!-- Iframe rendering for trusted mode: Full CSS support, scripts blocked -->
                    <iframe
                      #emailContentContainer
                      [srcdoc]="sanitizedHtml"
                      sandbox="allow-same-origin"
                      (load)="onIframeLoad($event)"
                      class="w-full border border-surface-200 rounded-sm shadow-sm bg-white"
                      style="border: 0; display: block"
                      title="Email content"
                    ></iframe>
                  } @else {
                    <!-- Standard rendering with DOMPurify sanitization -->
                    <div
                      #emailContentContainer
                      class="email-html-frame bg-white dark:bg-white dark:text-surface-900 text-surface-900 border border-surface-200 rounded-sm shadow-sm"
                    >
                      <div class="m-1 email-html-content prose prose-sm max-w-none" [innerHTML]="sanitizedHtml"></div>
                    </div>
                  }
                } @else {
                  <div class="text-center py-12 text-surface-400">
                    <i class="pi pi-code text-4xl mb-3 block"></i>
                    <p>No HTML content available</p>
                  </div>
                }
              </div>
            </p-tabpanel>

            <p-tabpanel value="text">
              <div class="h-full overflow-auto p-4">
                @if (hasText()) {
                  <pre
                    class="whitespace-pre-wrap break-all font-sans text-sm text-surface-900 dark:text-surface-100 max-w-full overflow-x-hidden"
                    >{{ email.parsedContent!.text }}</pre
                  >
                } @else {
                  <div class="text-center py-12 text-surface-400">
                    <i class="pi pi-align-left text-4xl mb-3 block"></i>
                    <p>No text content available</p>
                  </div>
                }
              </div>
            </p-tabpanel>

            <p-tabpanel value="headers">
              <div class="h-full overflow-auto">
                <app-email-headers [headers]="getHeadersList()" />
              </div>
            </p-tabpanel>

            <p-tabpanel value="auth">
              <div class="h-full overflow-auto">
                <app-email-auth-results [authResults]="email.parsedContent.authResults" />
              </div>
            </p-tabpanel>

            @if (isSpamAnalysisEnabled()) {
              <p-tabpanel value="spam">
                <div class="h-full overflow-auto">
                  <app-email-spam-analysis [spamAnalysis]="email.parsedContent.spamAnalysis" />
                </div>
              </p-tabpanel>
            }

            @if (hasAttachments()) {
              <p-tabpanel value="attachments">
                <div class="h-full overflow-auto">
                  <app-email-attachments [attachments]="email.parsedContent!.attachments" />
                </div>
              </p-tabpanel>
            }

            @if (hasLinks()) {
              <p-tabpanel value="links">
                <div class="h-full overflow-auto">
                  <app-email-links [links]="email.parsedContent!.links" />
                </div>
              </p-tabpanel>
            }
          </p-tabpanels>
        </p-tabs>
      } @else {
        <div class="flex items-center justify-center h-full text-surface-400">
          <div class="text-center">
            <i class="pi pi-file text-4xl mb-3 block"></i>
            <p>Email body not available</p>
          </div>
        </div>
      }
    </div>
  } @else {
    <div class="flex items-center justify-center h-full text-surface-400">
      <div class="text-center">
        <i class="pi pi-envelope text-6xl mb-4 block"></i>
        <p>Select an email to view details</p>
      </div>
    </div>
  }
</div>
